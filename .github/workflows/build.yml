name: Signed Android Build and Release

on:
  push:
    branches:
      - master  # æ¨é€åˆ°masteråˆ†æ”¯æ—¶è§¦å‘æ„å»º
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ç¬¬ä¸€ä¸ªç¯èŠ‚ï¼šæ„å»ºç­¾åå®‰å“åº”ç”¨
  Android:
    name: Build Signed Android
    runs-on: ubuntu-latest
    outputs:
      apk_path: ${{ steps.set_outputs.outputs.apk_path }}
      version: ${{ steps.extract_version.outputs.version }}
      changelog_body: ${{ steps.extract_version.outputs.changelog_body }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œä¾¿äºè§£æchangelog

    - name: Check ChangLog.md existence
      id: check_changelog
      run: |
        if [ -f "log/ChangLog.md" ]; then
          echo "âœ… ChangLog.md found at log/ChangLog.md"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ ChangLog.md not found at log/ChangLog.md"
          echo "exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    - name: Extract latest version from ChangLog
      id: extract_version
      run: |
        CHANGELOG_FILE="log/ChangLog.md"
        
        # æå–æœ€æ–°çš„ç‰ˆæœ¬å·ï¼ˆç¬¬ä¸€ä¸ªé‡åˆ°çš„ç‰ˆæœ¬å·ï¼‰
        LATEST_VERSION=$(grep -m 1 '^## \[' "$CHANGELOG_FILE" | sed -E 's/^## \[([^]]+)\].*$/\1/')
        
        if [ -z "$LATEST_VERSION" ]; then
          echo "âŒ No version found in ChangLog.md"
          exit 1
        fi
        
        echo "Latest version from ChangLog: $LATEST_VERSION"
        echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
        # æå–è¯¥ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
        CHANGELOG_BODY=$(awk -v version="$LATEST_VERSION" '
          BEGIN { found=0; output="" }
          /^## \[/ {
              if (found) exit
              if ($0 ~ "## \\[" version "\\]") {
                  found=1
                  next
              }
          }
          found && /^## \[/ { exit }
          found { 
              # è·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œæœ¬èº«
              if (!($0 ~ /^## \[/)) {
                  output = output $0 "\n"
              }
          }
          END { print output }
        ' "$CHANGELOG_FILE")
        
        echo "changelog_body<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Decode Keystore from Secrets
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
        echo "âœ… Keystore created from secrets"
    - name: Build Signed Release APK
      run: |
        ./gradlew assembleRelease \
          -PreleaseStoreFile=release.keystore \
          -PreleaseStorePassword=${{ secrets.KEYSTORE_PASSWORD }} \
          -PreleaseKeyAlias=${{ secrets.KEY_ALIAS }} \
          -PreleaseKeyPassword=${{ secrets.KEY_PASSWORD }} \
          --stacktrace --no-daemon
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: signed-apk-${{ steps.extract_version.outputs.version }}
        path: app/build/outputs/apk/release/*.apk
        retention-days: 7

    - name: Set output parameters
      id: set_outputs
      run: |
        APK_PATH=$(ls app/build/outputs/apk/release/*.apk | head -n 1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "APK Path: $APK_PATH"
    - name: Cleanup Keystore
      run: rm -f app/release.keystore

  # ç¬¬äºŒä¸ªç¯èŠ‚ï¼šå‘å¸ƒåˆ°GitHub Release
  Release:
    name: Release
    runs-on: ubuntu-latest
    needs: [Android]  # ä¾èµ–Androidæ„å»ºç¯èŠ‚
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºRelease

    steps:
    - name: Download Signed APK
      uses: actions/download-artifact@v4
      with:
        name: signed-apk-${{ needs.Android.outputs.version }}
        path: ./release-apk

    - name: Get APK file info
      id: apk_info
      run: |
        APK_FILE=$(ls ./release-apk/*.apk | head -n 1)
        APK_NAME=$(basename "$APK_FILE")
        echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        echo "Found APK: $APK_FILE"
    - name: Create Git Tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "${{ needs.Android.outputs.version }}" -m "Release ${{ needs.Android.outputs.version }}"
        git push origin "${{ needs.Android.outputs.version }}"
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.Android.outputs.version }}
        name: Release ${{ needs.Android.outputs.version }}
        body: |
          # Release ${{ needs.Android.outputs.version }}
          
          ## å˜æ›´å†…å®¹
          ${{ needs.Android.outputs.changelog_body }}
          
          ---
          *æ„å»ºä¿¡æ¯: ${GITHUB_SHA:0:7} @ $(date +"%Y-%m-%d %H:%M:%S")*
        draft: false
        prerelease: false
        files: ${{ steps.apk_info.outputs.apk_file }}

    - name: Release Success Notification
      run: |
        echo "ğŸ‰ Signed Release published successfully!"
        echo "ğŸ·ï¸  Version: ${{ needs.Android.outputs.version }}"
        echo "ğŸ“ APK: ${{ steps.apk_info.outputs.apk_name }}"
        echo "ğŸ”— Release created for tag: ${{ needs.Android.outputs.version }}"
        echo "â° Published at: $(date)"