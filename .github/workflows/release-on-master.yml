name: Android Test Build (Enhanced)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    # 新增：列出项目结构，确认无误
    - name: Debug - List project structure
      run: find . -name "*.gradle" -o -name "gradlew" -o -name "AndroidManifest.xml" | head -20

    # 新增：验证Gradle配置
    - name: Validate Gradle configuration
      run: ./gradlew --version

    # 构建调试版APK
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace --no-daemon --console=verbose

    # 新增：验证APK文件是否生成且有效
    - name: Verify APK file
      run: |
        APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
        if [ -f "$APK_PATH" ]; then
          echo "APK found at: $APK_PATH"
          ls -la $APK_PATH
          echo "APK size: $(du -h $APK_PATH | cut -f1)"
        else
          echo "ERROR: No APK file found!"
          find . -name "*.apk"
          exit 1
        fi

    # 新增：尝试验证APK签名信息
    - name: Check APK signatures (Optional)
      run: |
        APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
        # 尝试检查APK签名，如果命令可用的话
        if command -v apksigner &> /dev/null; then
          echo "Checking APK signature with apksigner..."
          apksigner verify --verbose $APK_PATH || echo "apksigner check completed"
        else
          echo "apksigner not available, skipping signature check"
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-with-logs
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/logs/
        retention-days: 7

    - name: Success message
      run: echo "✅ Build completed. Check the Artifacts tab for the APK."